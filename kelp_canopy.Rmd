---
title: "Kelp Canopy Cover Summary Using Administrative Kelp Bed Shapefiles"
author: "Gina Contolini"
date: Updated `r format(Sys.time(), '%d %B %Y')`
output: 
  html_document:
    fig_crop: FALSE
header-includes:
- \usepackage{caption}
- \captionsetup[figure]{labelformat=empty}
toc: FALSE
        
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE)
options(knitr.table.format = "latex")
# to create a PDF output, change "output:html_document" to "output: pdf_document" in the header above.
# note about fig_crop:FALSE. This makes the PDF output look nicer by putting spaces btwn the figures instead of smashing them as close together as possible. It doesn't do anything to the HTML output as far as I can tell.
# how to assign username: git config --global user.name "gcontolini"
# how to add, commit, and add message in terminal: git commit -am "commit message"
# how to write commit message in terminal: write message then press esc and :wq to save and exit

#### Load libraries ####
library(ggplot2) # plotting
library(ggpubr) # arranging plots
library(scales) # let's you put commas in the axis labels for thousands
library(dplyr) # data manipulations
library(tidyr) # data cleaning
library(readr) # better data reading
library(ncdf4)
library(sf) # special features. probably mapping. 
library(sp) # spatial data
library(lubridate) # manipulating dates easily
library(knitr) # to knit the Rmd file
library(kableExtra) # pretty tables
library(bookdown) # pretty table additions

#### ggplot theme ####
my.theme = theme( 
   panel.background = element_blank(), 
   panel.grid.minor.x = element_blank(),
   panel.grid.major.x = element_blank(),
   panel.grid = element_blank(),
   axis.text  = element_text(size=10, face='bold', color='black'), #makes axis labels bigger
   axis.title = element_text(size=10, face="bold"), #makes axis title bigger and bold
   #axis.title.y = element_text(margin=margin(0,10,0,5)), #pushes the y axis title away from the y axis labels
   strip.background = element_blank(),
   #legend.title = element_blank(),
   #legend.text = element_text(size=8),
   legend.background = element_blank(), 
   legend.key = element_blank(), #makes the legend background behind the symbols go away.
   #axis.ticks.x = element_blank()
   axis.line = element_line(color = 'black'), 
   panel.border = element_blank(), # this removes the box around the plot   
   plot.title = element_text(size=12 ,face='bold', hjust = 0.5), # hjust 0.5 makes title centered
   axis.text.x = element_text(size = 10, angle = 90, vjust = 0.5, margin = margin(0,0,5,0)) # rotates x axis labels 90 degrees counter-clockwise, pushes bars onto x axis
)


#### Import data ####
# info on the data: https://sbclter.msi.ucsb.edu/data/catalog/package/?package=knb-lter-sbc.74

# Instructions from Dr. Tom Bell:
# “The output files show the Admin Bed # in the first column and the rest of the columns are quarters from 1984 - 2020. Area is in m2 and biomass is in fresh kg. Missing values (due to lack of imagery or clouds are labelled as -999).”

# Edible seaweed data from CDFW
# edible = read.csv('EdibleSeaweedHarvest_rfm_1-28-21.csv') # edible seaweed harvest. This one has months. That is important.
# kelp = read.csv('KelpHarvest_vers2_rfm_1-28-21.csv') # kelp harvest
```
For more reports like this, visit my RPubs user profile: https://rpubs.com/gcontolini

# Objective
Summarize California kelp abundance trends from Landsat satellite imagery (SBC LTER et al. 2022) in three regions: north (Oregon to San Frrancisco), cenral (San Francisco to Point Conception), and south (Point Conception to Mexico).

# Methods
## Satellite imagery
Kelp canopy area data are from the Santa Barbara Coastal Long-term Ecological Research Landsat satellite data series updated through all four quarters of 2021 (Santa Barbara Coastal LTER et al. 2022; https://portal.edirepository.org/nis/mapbrowse?scope=knb-lter-sbc&identifier=74&revision=15). The data represents a time series of canopy area of giant kelp, *Macrocystis pyrifera*, and bull kelp, *Nereocystis luetkeana* derived from Landsat 5 Thematic Mapper (TM), Landsat 7 Enhanced Thematic Mapper Plus (ETM+), and Landsat 8 Operational Land Imager (OLI) satellite imagery, along with relevant metadata. The kelp canopy is composed of the portions of fronds and stipes floating on the surface of the water. Canopy area (m) data are given for individual 30 x 30 meter pixels for all coastal areas of California, including the Northern and Southern Channel Islands.

Data were derived from the three Landsat sensors listed above. Observations are made on a 16 day repeat cycle for each instrument, but the temporal coverage is irregular because of cloud cover, instrument failure, and the mission length of each sensor (TM: 1984 – 2011, ETM+: 1999 – present, OLI: 2013 – present). Estimates of canopy area are derived from the fractional cover of kelp canopy determined from satellite surface reflectance. Updates to the 2021 dataset include correcting cloud reflectance errors and improving the landmasking procedure, which increased the detection of kelp especially in the northern region. The different Landsat sensors were calibrated to each other using simulated Landsat data derived from hyperspectral imagery. Missing data due to the ETM+ scan line corrector error were filled using a synchrony-based gap filling method. 

Data are organized into a single NetCDF file and contain the quarterly area means for each Landsat pixel across the three sensors. Relevant metadata such as number of Landsat estimates from which the mean was derived, the number of estimates from each sensor, standard error for each quarterly estimate, spatial coordinates, and date are all included in the file.

## Plotting
Figures were created using the above dataset in conjunction with shapefiles of state waters spanning divided into three regions as described above. 

```{r Load Landsast data into AKB shapefiles, include = FALSE}
# ## THIS HAS ALL BEEN COMMENTED BECAUSE IT IS JUST THE WORK THAT LED TO THE CSVS I'M USING FOR THE FIGS

# #Regional Kelp Biomass and Area Dynamics
# #Tom Bell
# #March 1, 2021
# # **Please let me know if you need help with any step!**
# 
# #Install Packages **(Only the first time you ever run this script)**
# #The first time you ever run this script, please install these packages by removing the '#' in front of each line (lines 8 - 10)
# # install.packages('ncdf4')
# # install.packages('sf')
# # install.packages('sp')
# 
# #Load Required Packages
# #You need to load these packages each time you restart an R session and run this script
# library(ncdf4)
# library(sf)
# library(sp)
# 
# #Set Work Directory
# #This is a folder on your computer where all input files and outputs files will be placed
# # **Please update this path to the working directory on your computer**
# # **Note that on a Windows machine the forward slashes "/" have to be changed to back slashes "\"
# setwd('/Users/gcontolini/OneDrive - California Department of Fish and Wildlife/Kelp Team/ESR Materials/Figures and data/total abundance')
# 
# #Load Admin Bed Shapefile
# #Place the lat/lon version of the Admin Bed shapefile in your working directory
# regions <- st_read('regional.shp')
# 
# #Open Kelp NetCDF File
# #Place the NetCDF file in your working directory
# #The file can be found here: https://sbclter.msi.ucsb.edu/data/catalog/package/?package=knb-lter-sbc.74
# # nc_data <- nc_open('kelpCanopyFromLandsat_2020_v2.nc') # old data
# nc_data <- nc_open('LandsatKelpBiomass_2022_Q1_withmetadata.nc')
# 
# #Load necessary variables from NetCDF File
# lon <- ncvar_get(nc_data, 'longitude')
# lat <- ncvar_get(nc_data, 'latitude')
# years <- ncvar_get(nc_data, 'year')
# quarters <- ncvar_get(nc_data, 'quarter')
# biomass <- ncvar_get(nc_data, 'biomass')
# area <- ncvar_get(nc_data, 'area')
# 
# #Make Coordinate Dataframe
# coords <- data.frame(lon,lat)
# 
# #Create output matrices
# LN = dim(quarters)
# output_biomass <- matrix(ncol=LN, nrow=3)
# output_area <- matrix(ncol=LN, nrow=3)
# 
# for(i in 1:3){
#   
#   #Pull shapefile coordinates from each admin bed
#   #bed_coords <- as.data.frame(regions[i,]$geometry[[1]][[1]][[1]])
#   bed_coords <- as.data.frame(regions[i,]$geometry[[1]][[1]])
#   
#   #Find the kelp coordinates that exist inside each admin bed polygon
#   kelp_poly <- point.in.polygon(lon, lat, bed_coords$V1, bed_coords$V2, mode.checked=FALSE)
#   TF <- which(kelp_poly %in% 1)
#   
#   #Extract biomass and area data for each polygon
#   bio_bed <- biomass[TF,] 
#   area_bed <- area[TF,] 
#   
#   #Sum biomass and area
#   bio_bed_sum <- colSums(bio_bed, na.rm = TRUE, dims = 1)
#   area_bed_sum <- colSums(area_bed, na.rm = TRUE, dims = 1)
#   
#   #Remove Columns w/ >25% No Data (Clouds)
#   #Find all NA values (missing data) in the kelp dataset
#   bio_bed_NA = is.na(bio_bed)
#   area_bed_NA = is.na(area_bed)
#   
#   #Find number of kelp pixels in the polygon
#   L = dim(bio_bed)
#   
#   #Calculate the percent of NAs for each season
#   bio_bed_NA_percent <- colSums(bio_bed_NA, na.rm = TRUE)/L[1]
#   area_bed_NA_percent <- colSums(area_bed_NA, na.rm = TRUE)/L[1]
#   
#   #Find seasons with greater than 20% missing data
#   NA_GT <- which(bio_bed_NA_percent > 0.25)
#   NA_GTA <- which(area_bed_NA_percent > 0.25)
#   
#   #Set seasons with greater than 20% missing data to -999
#   bio_bed_sum[NA_GT] = -999
#   area_bed_sum[NA_GTA] = -999
#   
#   #Add summed kelp canopy data to matrix
#   output_biomass[i,] <- bio_bed_sum
#   output_area[i,] <- area_bed_sum
#   
# }
# 
# #Transpose Quarter and Year data
# quarterst <- t(quarters)
# yearst <- t(years)
# 
# #Add Quarter and Year data to output matrices
# output2_biomass <- rbind(quarterst, output_biomass)
# output3_biomass <- rbind(yearst, output2_biomass)
# output2_area <- rbind(quarterst, output_area)
# output3_area <- rbind(yearst, output2_area)
# 
# #Add region to output matrices
# region <- c('North','Central','South')
# regionNA <- c(rep(NA,2),region)
# output4_biomass <- cbind(regionNA, output3_biomass)
# output4_area <- cbind(regionNA, output3_area)
# 
# #Write CSV of kelp biomass time series for each region
# write.csv(output4_biomass, 'kelp_biomass_regional_output_2May2022.csv', row.names = FALSE)
# write.csv(output4_area, 'kelp_area_regional_output_2May2022.csv', row.names = FALSE)


output4_area <- read.csv('kelp_area_regional_output_2May2022.csv')

# I believe we only got countywide data directly from T Bell.
```

```{r kelp region canopy area tidying, include = FALSE}
canopy_area <- output4_area %>%
   as.data.frame()

# I want to plot area vs. year.quarter. This means year.quarter needs to be in a column. Currently all cols are separate. This is called wide format. I want tall format.

# create column names
names(canopy_area) <- paste(canopy_area[1,], canopy_area[2,], sep='.') # paste years with quarters to make each col have a unique name.

# rename the ID col for counties
names(canopy_area)[1] <- "region"

# remove first 2 rows since they are not canopy data, just IDs--year and quarter
canopy_area <- canopy_area[-c(1:2),] 

# convert to tall format
canopy_area_tall <- canopy_area %>% 
   pivot_longer(-'region', names_to = 'year.qtr', values_to = 'm2')

# separate year and quarter into two cols
canopy_area_tall <- canopy_area_tall %>%
   separate(col = year.qtr, sep = "[.]", into = c("year","qtr")) # omg. you have to hard bracket the period for some reason. wtf does [^[:alnum:]]+ mean and why aren't brackets used in the example?????? :((

# make number cols numeric
canopy_area_tall$year <- as.numeric(canopy_area_tall$year)
canopy_area_tall$qtr <- as.numeric(canopy_area_tall$qtr)
canopy_area_tall$m2 <- as.numeric(canopy_area_tall$m2)

# make quarters actual quarter decimals for plotting
qtrs <- seq(0,0.75,0.25)
for(i in 1:4) {
   canopy_area_tall$qtr[which(canopy_area_tall$qtr == i)] <- qtrs[i]
}

# add year and quarter to get a continuous time column. Note that the tibble hides the decimals place for no apparent reason but the sum is correct.
canopy_area_tall$year.qtr <- canopy_area_tall$year + canopy_area_tall$qtr

# Change negative area to NA
canopy_area_tall$m2[which(canopy_area_tall$m2 < 0)] = NA

# Convert m2 to km2
canopy_area_tall$km2 = canopy_area_tall$m2 / 1e6
```

# Figures
```{r kelp canopy area by region, fig.height = 3, fig.width = 10}

# All quarters
expand.a.little = 0.02

## North Coast
ggplot(canopy_area_tall[which(canopy_area_tall$region == 'North'),], aes(x = year.qtr, y = km2)) +
   geom_point() +
   geom_line() +
   scale_x_continuous(breaks = 1984:2021, expand = c(expand.a.little,0)) +
   scale_y_continuous(expand = c(expand.a.little, 0)) +
   labs(x = '',  y =  bquote('Canopy area'~(km^2))) +
   ggtitle('North Coast Quarterly') +
   my.theme

## Central Coast
ggplot(canopy_area_tall[which(canopy_area_tall$region == 'Central'),], aes(x = year.qtr, y = km2)) +
   geom_point() +
   geom_line() +
   scale_x_continuous(breaks = 1984:2021, expand = c(expand.a.little,0)) +
   scale_y_continuous(expand = c(expand.a.little, 0)) +
   labs(x = '',  y =  bquote('Canopy area'~(km^2))) +
   ggtitle('Central Coast Quarterly') +
   my.theme

## South Coast including Channel Islands
ggplot(canopy_area_tall[which(canopy_area_tall$region == 'South'),], aes(x = year.qtr, y = km2)) +
   geom_point() +
   geom_line() +
   scale_x_continuous(breaks = 1984:2021, expand = c(expand.a.little,0)) +
   scale_y_continuous(expand = c(expand.a.little, 0)) +
   labs(x = '',  y =  bquote('Canopy area'~(km^2))) +
   ggtitle('South Coast Quarterly') +
   my.theme
```

Figure 1. Quarterly canopy area in three regions as estimated from Landsat satellites (Santa Barbara Coastal LTER et al. 2022). Canopy area does not distinguish between bull kelp and giant kelp.  Missing values indicate no data is available. Data is updated through the first quarter of 2022.

# Tables

```{r exploring which quarters have the annual maximum, echo = FALSE}
qtr_max_region <- canopy_area_tall %>%
  group_by(region, year) %>%        # group by region and year
  slice(which.max(km2)) %>%      # find the maximum km2 value
  subset(select = -year.qtr) %>% # remove year.qtr col
  transmute(quarter = qtr*4+1)   # change quarters from decimals to 1,2,3,4

# Count how many quarters are the max per year per region
n_max_qtrs_region <- qtr_max_region %>%
  group_by(region, quarter) %>%
  summarise(number = length(quarter), .groups = 'drop') %>%
  complete(region, quarter, fill = list(number = 0)) # sets missing quarters to number = 0

kable(n_max_qtrs_region
      , digits = 2
      , booktabs = TRUE
      , row.names = FALSE
      , align = 'c'
      , linesep = ''
      , caption = 'Number of quarters with maximum annual canopy area'
) %>%
  kable_styling(latex_options = 'hold_position') # otherwise the table moves in the pdf



```


# Literature Cited
Santa Barbara Coastal LTER, T. Bell, K. Cavanaugh, and D. Siegel. 2022. SBC LTER: Time series of quarterly NetCDF files of kelp biomass in the canopy from Landsat 5, 7 and 8, since 1984 (ongoing) ver 14. Environmental Data Initiative. https://doi.org/10.6073/pasta/89b63c4b49b80fb839613e9d389d9902 (Accessed 2021-01-26).